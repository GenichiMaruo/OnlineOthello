# OnlineOthello クライアントアプリケーション（クライアント・バックエンド）

フロントエンドのNext.jsアプリケーションと連携するためのC言語で実装されたクライアントアプリケーションです。
このREADMEでは、クライアントアプリケーションの構成や各モジュールの役割について説明します。
フロントエンドの詳細については、以下のリンクを参照してください。

- [OnlineOthello クライアント・フロントエンド](./src/othello-front/README.md)

サーバーアプリケーションの詳細については、以下のリンクを参照してください。

- [OnlineOthello サーバーアプリケーション](../server/README.md)

## クライアントアプリケーション（client_app）

`client/src/client_app.c`は、C言語で実装されたOnlineOthelloのクライアントアプリケーションです。  
主な役割は以下の通りです。

- サーバーへの接続・切断、部屋作成・参加、ゲーム操作、チャット送信などのコマンドを標準入力から受け付ける
- サーバーからのメッセージを受信し、状態やイベントをJSON形式で標準出力に出力する
- ゲーム状態や接続状態を管理し、スレッド安全に動作する

このアプリケーションは、フロントエンド（Next.js）と標準入出力を通じて連携し、ユーザー操作やサーバーイベントをリアルタイムに反映します。

## JSONイベント出力モジュール（json_output.c）

`client/src/json_output.c`は、クライアントの状態やイベントをJSON形式で標準出力に出力するためのモジュールです。  
このモジュールは主にフロントエンド（Node.js/Next.jsなど）と連携するために利用され、サーバーやクライアント内部で発生した各種イベントをJSONで通知します。

### 主な機能

- クライアント状態の変化、盤面更新、チャット受信、エラー、ログなどをJSON形式で出力
- 文字列のJSONエスケープやバッファオーバーフロー対策を実装
- スレッド安全な出力のため、必要に応じてミューテックスで保護
- 可変長引数（va_list）を使った柔軟なメッセージ生成
- 各種イベント（stateChange, boardUpdate, serverMessage, error, log, yourTurn, gameOver, rematchOffer, rematchResult, chatMessageなど）に対応

### 典型的な出力例

```json
{"type":"stateChange","state":"MyTurn","roomId":1,"color":1}
{"type":"boardUpdate","roomId":1,"board":[[0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0],...]}
{"type":"error","message":"Invalid command"}
{"type":"chatMessage","payload":{"roomId":1,"senderColor":2,"senderDisplayName":"Alice","message":"こんにちは","timestamp":1715850000}}
```

このモジュールにより、クライアントの状態やイベントをリアルタイムにフロントエンドへ伝えることができます。

## ネットワーク通信モジュール（network.c）

`client/src/network.c`は、クライアントとOthelloサーバー間のTCP通信を管理するモジュールです。  
サーバーへの接続・切断、メッセージ送信など、ネットワークに関する主要な処理を担当します。

### 主な機能

- サーバーへの接続確立（`connect_to_server`）
  - IPアドレスとポート番号を指定してTCP接続を行う
  - 接続状態の管理と状態変化イベントの送信
- サーバーとの接続終了（`close_connection`）
  - ソケットのシャットダウンとクローズ処理
  - 状態管理とログ出力
- サーバーへのメッセージ送信（`send_message_to_server`）
  - ソケットを通じてプロトコルに従ったメッセージを送信
  - 送信失敗時のエラー処理と自動切断
- エラー発生時や状態変化時には、`json_output.c`を通じてJSONイベントを出力

### 備考

- ソケット通信のエラーや切断は、状態遷移やエラーメッセージとしてフロントエンドに通知されます。
- サーバーとの通信ができない場合や異常終了時も、状態管理が適切に行われるよう設計されています。

## プロトコル層モジュール（protocol.c）

`client/src/protocol.c`は、クライアントとサーバー間でやり取りするバイナリメッセージの送受信を行う低レイヤのプロトコル実装です。  
ソケットを通じて`Message`構造体を確実に送受信するための関数を提供します。

### 主な機能

- メッセージ送信（`sendMessage`）
  - 指定したソケットに対して`Message`構造体全体を送信
  - 送信途中で切断やエラーが発生した場合はエラーを返す
  - 複数回の`send`で全バイト送信を保証
- メッセージ受信（`receiveMessage`）
  - 指定したソケットから`Message`構造体全体を受信
  - 受信途中で切断やエラーが発生した場合はエラーや切断を返す
  - 複数回の`recv`で全バイト受信を保証

### 備考

- 通信はバイナリ形式で行われ、`Message`構造体のサイズ分だけ送受信します。
- 送信・受信ともに、部分送信・部分受信を考慮してループで全バイトを処理します。
- 通信エラーや切断時には標準エラー出力にエラーメッセージを出力します。

## サーバーメッセージ受信・処理モジュール（receiver.c）

`client/src/receiver.c`は、サーバーからのメッセージを受信し、クライアントの状態やUIに反映するための処理を行うモジュールです。  
受信専用スレッドを起動し、サーバーからの通知やレスポンスをリアルタイムに処理します。

### 主な機能

- サーバーからのメッセージ受信スレッド（`receive_handler`）
  - サーバーとの接続が維持されている間、メッセージをループで受信
  - 切断やエラー時には状態を更新し、JSONイベントで通知
- サーバーメッセージの内容ごとの処理（`process_server_message`）
  - 部屋作成・参加・開始・盤面更新・ターン通知・無効手・ゲーム終了・再戦・チャット・エラーなど、各種メッセージタイプごとに状態遷移やイベント出力を実施
  - 状態管理や盤面更新、チャット受信などをスレッドセーフに処理
  - 必要に応じてJSONイベント（`json_output.c`）を通じてフロントエンドに通知

### 備考

- 受信したメッセージはすべてロック付きで状態管理し、UIや他スレッドと競合しないよう設計されています。
- サーバーからの通知に応じて、クライアントの状態や盤面、チャット、再戦などの情報が即座に反映されます。

## クライアント状態管理モジュール（state.c）

`client/src/state.c`は、クライアントの状態・接続情報・ゲーム盤面などを一元的かつスレッドセーフに管理するモジュールです。  
複数スレッドからのアクセスをミューテックスで保護し、状態遷移や情報取得・更新を安全に行います。

### 主な機能

- クライアント状態（`ClientState`）の取得・設定（安全版/unsafe版）
- サーバー接続用ソケットFD、受信スレッドIDの管理
- ルームID、自分の色、ゲーム盤面の管理と取得・設定
- 状態や盤面の初期化・リセット
- 状態enum値を文字列へ変換（`state_to_string`）

### 備考

- すべての状態・情報はグローバル変数で保持され、必要に応じてミューテックスで排他制御されます。
- unsafe系関数は呼び出し元でロック済み前提で利用します（パフォーマンス向上や多重ロック回避のため）。
- ゲーム進行やUI更新、ネットワーク処理など、他のモジュールから本モジュール経由で状態管理が行われます。

## 通信プロトコル定義ヘッダ（protocol.h）

`client/src/protocol.h`は、クライアントとサーバー間でやり取りされるメッセージの型・構造・プロトコル仕様を定義した共通ヘッダファイルです。  
このファイルはサーバー・クライアント双方でインクルードされ、通信内容の整合性を保証します。

### 主な内容

- メッセージタイプ（`MessageType`）のenum定義  
  - 部屋作成/参加/開始/コマ配置/再戦/チャット/エラーなど、全通信ケースを網羅
- 各メッセージタイプごとのペイロード構造体定義  
  - 盤面情報、チャット内容、部屋情報、通知メッセージなど
- すべての通信をカバーする共通`Message`構造体  
  - `type`でメッセージ種別を判別し、`union`で各種ペイロードを格納
- 通信補助関数のプロトタイプ宣言  
  - `sendMessage`/`receiveMessage`でバイナリ送受信

### 備考

- このファイルの定義をサーバー・クライアント双方で利用することで、通信仕様のズレや型不一致を防ぎます。
- 盤面サイズや最大文字数などの定数もここで一元管理されています。
- チャットや再戦、ゲーム進行などOthelloの全機能に対応した設計です。

## ビルド・配置用Makefileについて

このディレクトリの`Makefile`は、クライアントアプリケーション（C言語）のビルドと、ビルド後の実行ファイルの自動配置を行います。

### 主な特徴

- `make`コマンドでCソースをビルドし、`client_app.out`という実行ファイルを生成します。
- ビルドした実行ファイルは、Next.js製フロントエンドアプリケーションの`middleware/bin`ディレクトリなど、フロントエンドから実行できる場所に自動でコピーされます。
- フロントエンド（Next.js）は、この実行ファイルを直接起動してクライアントロジックを利用します。  
  そのため、Cの実行ファイル単体で起動するのではなく、**フロントエンドから呼び出される補助プログラム**として動作します。
- `make clean`でビルド生成物やコピー先ディレクトリもまとめて削除できます。

### 運用イメージ

1. `make`でビルド＆フロントエンド用ディレクトリに自動コピー
2. Next.jsアプリケーションが必要に応じてこの実行ファイルを起動し、標準入出力でやり取り
3. Cクライアントの実行ファイルは、フロントエンドの一部として動作

この仕組みにより、フロントエンドとCクライアント間の連携がシームレスに行えます。